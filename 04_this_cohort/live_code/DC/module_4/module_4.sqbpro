<?xml version="1.0" encoding="UTF-8"?><sqlb_project><db path="C:/Users/ofirs/OneDrive/Desktop/DSI PRACTICE/sql/05_src/sql/farmersmarket.db" readonly="0" foreign_keys="1" case_sensitive_like="0" temp_store="0" wal_autocheckpoint="1000" synchronous="2"/><attached/><window><main_tabs open="structure browser pragmas query" current="3"/></window><tab_structure><column_width id="0" width="300"/><column_width id="1" width="0"/><column_width id="2" width="100"/><column_width id="3" width="12652"/><column_width id="4" width="0"/><expanded_item id="0" parent="1"/><expanded_item id="1" parent="1"/><expanded_item id="2" parent="1"/><expanded_item id="3" parent="1"/><expanded_item id="4" parent="1"/></tab_structure><tab_browse><table title="customer" custom_title="0" dock_id="16" table="4,8:maincustomer"/><table title="booth" custom_title="0" dock_id="2" table="4,5:mainbooth"/><table title="customer" custom_title="0" dock_id="15" table="4,8:maincustomer"/><table title="vendor" custom_title="0" dock_id="14" table="4,6:mainvendor"/><table title="vendor_inventory" custom_title="0" dock_id="13" table="4,16:mainvendor_inventory"/><table title="booth" custom_title="0" dock_id="12" table="4,5:mainbooth"/><table title="booth" custom_title="0" dock_id="11" table="4,5:mainbooth"/><table title="customer_purchases" custom_title="0" dock_id="10" table="4,18:maincustomer_purchases"/><table title="booth" custom_title="0" dock_id="17" table="4,5:mainbooth"/><table title="customer_purchases" custom_title="0" dock_id="10" table="4,18:maincustomer_purchases"/><table title="product" custom_title="0" dock_id="9" table="4,7:mainproduct"/><table title="customer_purchases" custom_title="0" dock_id="14" table="4,18:maincustomer_purchases"/><table title="booth" custom_title="0" dock_id="16" table="4,5:mainbooth"/><table title="product" custom_title="0" dock_id="15" table="4,7:mainproduct"/><table title="booth" custom_title="0" dock_id="17" table="4,5:mainbooth"/><dock_state state="000000ff00000000fd0000000100000002000004ec000002a2fc0100000002fb000000160064006f0063006b00420072006f00770073006500310100000000ffffffff0000000000000000fc00000000000004ec000001c100fffffffa000000120100000013fb000000160064006f0063006b00420072006f00770073006500320100000000ffffffff000001c100fffffffb000000180064006f0063006b00420072006f007700730065003100390000000000ffffffff0000000000000000fb000000160064006f0063006b00420072006f00770073006500370000000000ffffffff0000000000000000fb000000160064006f0063006b00420072006f00770073006500370000000000ffffffff0000000000000000fb000000160064006f0063006b00420072006f00770073006500380000000000ffffffff0000000000000000fb000000160064006f0063006b00420072006f00770073006500390100000000ffffffff000001c100fffffffb000000180064006f0063006b00420072006f007700730065003100300100000000ffffffff000001c100fffffffb000000180064006f0063006b00420072006f007700730065003100340100000000ffffffff000001c100fffffffb000000180064006f0063006b00420072006f007700730065003100350100000000ffffffff000001c100fffffffb000000180064006f0063006b00420072006f007700730065003100360100000000ffffffff000001c100fffffffb000000180064006f0063006b00420072006f007700730065003100370100000000ffffffff000001c100fffffffb000000180064006f0063006b00420072006f007700730065003100300100000000ffffffff000001c100fffffffb000000180064006f0063006b00420072006f007700730065003100310100000000ffffffff000001c100fffffffb000000180064006f0063006b00420072006f007700730065003100320100000000ffffffff000001c100fffffffb000000180064006f0063006b00420072006f007700730065003100330100000000ffffffff000001c100fffffffb000000180064006f0063006b00420072006f007700730065003100340100000000ffffffff000001c100fffffffb000000180064006f0063006b00420072006f007700730065003100350100000000ffffffff000001c100fffffffb000000180064006f0063006b00420072006f007700730065003100360100000000ffffffff000001c100fffffffb000000180064006f0063006b00420072006f007700730065003100370100000000ffffffff000001c100ffffff000004ec0000000000000004000000040000000800000008fc00000000"/><default_encoding codec=""/><browse_table_settings><table schema="main" name="booth" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="128"/><column index="2" value="153"/><column index="3" value="300"/><column index="4" value="101"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="customer" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="109"/><column index="2" value="181"/><column index="3" value="178"/><column index="4" value="194"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="customer_purchases" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort><column index="2" mode="0"/></sort><column_widths><column index="1" value="96"/><column index="2" value="89"/><column index="3" value="112"/><column index="4" value="112"/><column index="5" value="76"/><column index="6" value="226"/><column index="7" value="146"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="product" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="96"/><column index="2" value="300"/><column index="3" value="150"/><column index="4" value="179"/><column index="5" value="152"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="temp" name="ranked_days" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="96"/><column index="2" value="89"/><column index="3" value="112"/><column index="4" value="109"/><column index="5" value="76"/><column index="6" value="226"/><column index="7" value="146"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="vendor" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="89"/><column index="2" value="300"/><column index="3" value="300"/><column index="4" value="223"/><column index="5" value="220"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="vendor_inventory" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="112"/><column index="2" value="76"/><column index="3" value="93"/><column index="4" value="99"/><column index="5" value="120"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table></browse_table_settings></tab_browse><tab_sql><sql name="SQL 2">/* MODULE 4 */
/* NULL Management */


/* 1. IFNULL: Missing product_size, missing product_qty_type */ 

SELECT*,

ifnull (product_size, 'Unknown') as new_product_size
 FROM product;
--replace in another column 
SELECT *
, ifnull(product_size, product_name) as sillyrrplacemnt
FROM product;
/* 2. Coalesce */

SELECT *
,coalesce (product_size, product_qty_type, 'missing') as replacement -- if the value is null so the second value and in the second in null so missing 
,coalesce (product_qty_type, product_size, 'missing') as anotherreplacemnt
-- we can get  the same result in this way: 
, ifnull(ifnull (product_qty_type, product_size),'missing') as onelastreplacment

From product; 

/* 3. NULLIF
finding values in the product_size column that are &quot;blank&quot; strings and setting them to NULL if they are blank */
SELECT* 
--,ifnull(product_size, 'Unknown')
--,nullif (product_size, '') 
, ifnull(nullif(product_size, ''),'unknown') as newquant
, coalesce(nullif(product_size, ''),'unknown') as newquantII
FROM product;


/* 4. NULLIF 
filtering which rows are null or blank */
SELECT* 
FROM product

WHERE nullif(product_size,'') IS NULL
-- this is a way to capture invalid values! 
</sql><sql name="SQL 7">/* MODULE 4 */
/* NULLIF Budget (example from the slides) */

/* The following example creates a budgets table to show a department (dept) 
...its current budget (current_year) and its previous budget (previous_year). 

For the current year, NULL is used for departments with budgets that have not changed from the previous year, 
and 0 is used for budgets that have not yet been determined. 

To find out the average of only those departments that receive a budget and to include the budget value 
from the previous year (use the previous_year value, where the current_year is NULL), 
combine the NULLIF and COALESCE functions. */

DROP TABLE IF EXISTS temp.budgets; 
CREATE TEMP TABLE IF NOT EXISTS temp.budgets (
dept STRING
,current_year INT
,previous_year INT
);


INSERT INTO temp.budgets VALUES 
('software',1000,1000)
, ('candles',NULL,500)
, ('coffee', 400, 200)
, ('pencils',0, 50);


/*examine each of these columns */
SELECT 
NULLIF(current_year, previous_year)
--,NULLIF(COALESCE(current_year, previous_year), 0.00)
--,
--AVG(NULLIF(COALESCE(current_year, previous_year), 0.00)) 
FROM budgets


/* more NULLIF here: 
https://learn.microsoft.com/en-us/sql/t-sql/language-elements/nullif-transact-sql?view=sql-server-ver17
*/

</sql><sql name="SQL 10">/* MODULE 4 */
/* Windowed functions: row_number */


/* 1. What product is the highest price per vendor */
SELECT x.*
,product_name
FROM (
		SELECT 
		vendor_id
		,product_id
		,original_price
		,market_date
		,ROW_NUMBER() OVER (PARTITION BY vendor_id ORDER BY original_price DESC) as price_rn

		FROM vendor_inventory
) x

INNER JOIN product as p
	ON x.product_id = p.product_id

WHERE x.price_rn = 1;

/* See how this varies from using max due to the group by 
SELECT vendor_id,
--product_id,
MAX(original_price)

FROM vendor_inventory
GROUP BY vendor_id--,product_id

*/

--highest single purchace in a day per custumer: 
SELECT*
FROM(
	SELECT

	customer_id
	,product_id
	,market_date
	,quantity
	,quantity*cost_to_customer_per_qty as cost
	,row_number() OVER (PARTITION BY customer_id ORDER BY quantity*cost_to_customer_per_qty DESC) as sales_rank

	FROM customer_purchases


)x
WHERE x.sales_rank = 1 
ORDER BY cost DESC</sql><sql name="SQL 9">/* MODULE 4 */
/* Windowed functions: dense_rank, rank, row_number */


/* 1. Compare dense_rank, rank, and row_number */

DROP TABLE IF EXISTS TEMP.row_rank_dense;

CREATE TEMP TABLE IF NOT EXISTS TEMP.row_rank_dense
(
emp_id INT,
salary INT
);

INSERT INTO temp.row_rank_dense
VALUES
(1,200000),
(2,200000),
(3, 160000),
(4, 120000),
(5, 125000),
(6, 165000),
(7, 230000),
(8, 100000),
(9, 165000),
(10, 100000),
(11, 90000);

SELECT *
,row_number () OVER (ORDER BY salary DESC) as [row_number]
,rank () OVER (ORDER BY salary DESC) as [rank]
,dense_rank () OVER (ORDER BY salary DESC) as [dense_rank]

FROM row_rank_dense
</sql><sql name="SQL 8">/* MODULE 4 */
/* Windowed functions: NTILE */


/* 1. Calculate quartile, quntiles, and percentiles from vendor daily sales */
SELECT *
,ntile (4) OVER (PARTITION BY vendor_name ORDER BY sales ASC) as quartile
,ntile (5) OVER (PARTITION BY vendor_name ORDER BY sales ASC) as quantiles
,ntile (10) OVER (PARTITION BY vendor_name ORDER BY sales ASC) as precentages

FROM (
-- vendor daily sales 
	SELECT 
	md.market_date
	,market_day
	,market_week
	,market_year
	,vendor_name
	,SUM(quantity*cost_to_customer_per_qty) AS sales

	FROM customer_purchases AS cp
	JOIN market_date_info AS md
		ON cp.market_date = md.market_date
	JOIN vendor AS v
		ON v.vendor_id = cp.vendor_id
		
	GROUP BY cp.market_date, v.vendor_id
	) x
</sql><sql name="SQL 11">/* MODULE 4 */
/* String Manipulations */


/* 1. ltrim, rtrim, trim*/
SELECT
LTRIM ('       ofir sivan      ') as [ltrim],
RTRIM ('       ofir sivan      ') as [rtrim],
TRIM ('       ofir sivan      ') as [trim];
/* 2. replace*/
SELECT
replace ('Itamar', 'mar', 'mama') as zoeitsa; 

SELECT
customer_first_name,
replace (customer_first_name,'a','mama') as custumamama
FROM customer; 

/* 3. upper, lower*/
SELECT 
customer_first_name, 
upper (customer_first_name) as customer_CAP
FROM customer; 

/* 4. concat with || */
SELECT 
customer_first_name, 
customer_first_name || ' ' || customer_last_name as customer_fullname
FROM customer; 

/* 5. substr */

SELECT DISTINCT
customer_last_name
,substr(customer_last_name,4) as [4]  --any length from the 4th charachter
,substr(customer_last_name,4,2) as [4,2]  -- length of 2 from the 4th charachter
,substr(customer_last_name,-5,4) as [-5,4]  -- going fiv back from the end and count 4
FROM customer;

--INSERT 
--we use with substr


/* 6. length */
SELECT DISTINCT
customer_last_name,
length (customer_last_name) as len

FROM customer;

/* 7. unicode, char */
SELECT 
unicode ('o'); 

/* 8. REGEXP in a WHERE statement */
SELECT DISTINCT
customer_last_name
FROM customer
WHERE customer_last_name REGEXP'(a)$' ---filtering customer_last_name ending with a
</sql><sql name="SQL 12">/* MODULE 4 */
/* Substring &amp; instring together */


/* think of this as a comma delimiter ... but it's a bit silly ... do this in python/R instead unless you have to */

SELECT 
'FirstWord, SecondWord, ThirdWord',
 SUBSTR('FirstWord, SecondWord, ThirdWord',0, INSTR('FirstWord, SecondWord, ThirdWord',',')) as FirstDelim
 --,SUBSTR('FirstWord, SecondWord, ThirdWord',0, 10) as FirstDelim -- same thing but not dynamic
 ,SUBSTR('FirstWord, SecondWord, ThirdWord', 
  INSTR('FirstWord, SecondWord, ThirdWord',',')+1,
  INSTR('FirstWord, SecondWord, ThirdWord',',')+1) as SecondDelim
  
  ,SUBSTR('FirstWord, SecondWord, ThirdWord',
  INSTR(
    (SUBSTR('FirstWord, SecondWord, ThirdWord',
    INSTR('FirstWord, SecondWord, ThirdWord',',')+1))
  ,',') + 
  INSTR('FirstWord, SecondWord, ThirdWord',',')+1) AS ThirdDelim
</sql><sql name="SQL 33">/* MODULE 4 */
/* UNION */

/* 1. Find the most and least expensive product by vendor with UNION (and row_number!) */
SELECT 
vendor_id, product_id, original_price, rn_max as [row_number], 'max price' as type
FROM (

	SELECT
	vendor_id, 
	product_id, 
	original_price,
	row_number () OVER (PARTITION BY vendor_id ORDER BY original_price DESC) as rn_max
	FROM vendor_inventory
	)
WHERE rn_max = 1

UNION ALL

SELECT 
vendor_id, product_id, original_price, rn_min, 'min price' as type
FROM (

	SELECT
	vendor_id, 
	product_id, 
	original_price,
	row_number () OVER (PARTITION BY vendor_id ORDER BY original_price ASC) as rn_min
	FROM vendor_inventory
	)
WHERE rn_min = 1;</sql><sql name="SQL 52">/* MODULE 4 */
/* UNION */

/* 1. Emulate a FULL OUTER JOIN with a UNION */
DROP TABLE IF EXISTS temp.store1; 
CREATE TEMP TABLE IF NOT EXISTS temp.store1
(
costume TEXT,
quantity INT
);

INSERT INTO temp.store1
VALUES(&quot;tiger&quot;,6),
        (&quot;elephant&quot;,2),
        (&quot;princess&quot;, 4);


DROP TABLE IF EXISTS temp.store2;
CREATE TEMP TABLE IF NOT EXISTS temp.store2
(
costume TEXT,
quantity INT
);

INSERT INTO temp.store2
VALUES(&quot;tiger&quot;,2),
	(&quot;dancer&quot;,7),
	(&quot;superhero&quot;, 5);
	
SELECT s1.costume, s1.quantity as store1_quantitty, s2.costume, s2.quantity as store2_quantity  
FROM store1 as s1
LEFT join store2 as s2
	ON s1.costume = s2.costume

UNION ALL

SELECT s2.costume, s1.quantity,  s2.quantity

FROM store2 as s2
LEFT JOIN store1 as s1
	ON s1.costume = s2.costume
WHERE s1.costume is NULL</sql><sql name="SQL 53">/* MODULE 4 */
/* INTERSECT &amp; EXCEPT */

/* 1. Find products that have been sold (e.g. are in customer purchases AND product) */ 

SELECT product_id
from customer_purchases
INTERSECT
select product_id
from product;

/* 2. Find products that have NOT been sold (e.g. are NOT in customer purchases even though in product) */
SELECT x.product_id, product_name
FROM(
	select product_id
	from product
	except
	SELECT product_id
	FROM customer_purchases
)as x

JOIN product as p
	on x.product_id=p.product_id; 

/* 3. Directions matter... if we switch the order here:
products that do not exist, because no products purchased are NOT in the product table (e.g. are NOT in product even though in customer purchases)*/

-- returning 0 rows
select product_id
from customer_purchases
except
SELECT product_id
FROM product

/* 4. We can remake the intersect with a WHERE subquery for more details ...  */

select*
FROM product
WHERE product_id IN 
	(
	select product_id
	from customer_purchases
	INTERSECT
	SELECT product_id
	FROM product
	); 
</sql><sql name="assignment2.sql*" filename="C:/Users/ofirs/OneDrive/Desktop/DSI PRACTICE/sql/02_activities/assignments/DC_Cohort/assignment2.sql">-- Reference to file &quot;C:/Users/ofirs/OneDrive/Desktop/DSI PRACTICE/sql/02_activities/assignments/DC_Cohort/assignment2.sql&quot; (not supported by this version) --</sql><sql name="assignment1.sql" filename="C:/Users/ofirs/OneDrive/Desktop/DSI PRACTICE/sql/02_activities/assignments/DC_Cohort/assignment1.sql">-- Reference to file &quot;C:/Users/ofirs/OneDrive/Desktop/DSI PRACTICE/sql/02_activities/assignments/DC_Cohort/assignment1.sql&quot; (not supported by this version) --</sql><current_tab id="10"/></tab_sql></sqlb_project>
